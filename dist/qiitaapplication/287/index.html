<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>wp-app</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="## Build Setup"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/runtime.8b17cd4.js" as="script"><link rel="preload" href="/_nuxt/vendors/commons.ca01d4b.js" as="script"><link rel="preload" href="/_nuxt/app.1984cc1.js" as="script"><link rel="preload" href="/_nuxt/pages/_slug/_id.b892f06.js" as="script"><style data-vue-ssr-id="fa7ff0ca:0 56b15182:0">.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}</style><link rel="preload" href="/_nuxt/static/1598415284/qiitaapplication/287/payload.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div><div class="post"><h1>検索処理について</h1> <div class="content">
<p>MainActivityの虫眼鏡アイコンを押下した場合、検索ワードを入力して検索処理を実行する。またタグを押下すると、タグで検索処理を実行する。</p>



<figure class="wp-block-gallery columns-1 is-cropped"><ul class="blocks-gallery-grid"><li class="blocks-gallery-item"><figure><img loading="lazy" width="323" height="482" src="https://komugirice-myblog.s3.ap-northeast-1.amazonaws.com/wp-content/uploads/2020/08/qiitaApplicaton-search-min-1.png" alt="" data-id="351" data-full-url="https://komugirice-myblog.s3.ap-northeast-1.amazonaws.com/wp-content/uploads/2020/08/qiitaApplicaton-search-min-1.png" data-link="http://wordpressmyblog-env.eba-pyivcx8v.ap-northeast-1.elasticbeanstalk.com/qiitaapplicaton-search-min/" class="wp-image-351" srcset="https://komugirice-myblog.s3.ap-northeast-1.amazonaws.com/wp-content/uploads/2020/08/qiitaApplicaton-search-min-1.png 323w, https://komugirice-myblog.s3.ap-northeast-1.amazonaws.com/wp-content/uploads/2020/08/qiitaApplicaton-search-min-1-300x448.png 300w" sizes="(max-width: 323px) 100vw, 323px"></figure></li></ul></figure>



<div class="mb20 clearfix"></div>
<p class="caption mb20 clearfix">呼び出し先</p>
<p class="filename">MainActivity.kt</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="97" data-enlighter-title="" data-enlighter-group="">    private fun initEditText() {
        // 検索実行
        searchEditText.setOnEditorActionListener { textView, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                // EditTextに値がある場合
                if(textView.text.toString().isNotEmpty()) {
                    // SearchActivityに遷移
                    SearchActivity.start(
                        this,
                        textView.text.toString(),
                        false
                    )
                }
                //true
            }
            false
        }
    }</pre>



<p></p><div class="mb20 clearfix"></div>
<p class="filename">ArticleAdapter.kt</p><p></p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">            // タグのクリックリスナ
            holder.binding.tagGroup.setOnTagClickListener { tag, position ->

                // 押下したタグごとに遷移
                val itemsPos = holder.adapterPosition // positionを取得
                // SearchActivityに遷移
                (context as? Activity)?.also {
                    SearchActivity.start(it, tag.text, true)
                }

            }</pre>



<div class="mb20 clearfix"></div>
<p class="caption mb20 clearfix">呼び出し元</p>
<div class="mb20 clearfix"></div>
<p class="filename">SearchActivity.kt</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="44" data-enlighter-title="" data-enlighter-group="">    /** 検索タイプ */
    private val searchType by lazy { if (intent.getBooleanExtra(KEY_IS_SEARCH_BY_TAG, false)) SEARCH_TAG else SEARCH_BODY }
    /** 検索クエリ */
    private val searchQuery by lazy { intent.getStringExtra(KEY_SEARCH_WORD) }

</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="88" data-enlighter-title="" data-enlighter-group="">    private fun initViewModel() {
        viewModel = ViewModelProviders.of(this).get(ArticleViewModel::class.java).apply {
            // QiitaApiが実行されて正常終了した
            items.observe(this@SearchActivity, Observer {
                binding.apply {
                    customAdapter.refresh(it)
                    swipeRefreshLayout.isRefreshing = false
                }
            })
            // QiitaAPIでExceptionが発生した
            isException.observe(this@SearchActivity, Observer {
                when(it) {
                    is UnknownHostException -> {
                        showErrorDialog(
                            R.string.title_network_error,
                            R.string.message_network_error)
                    }
                    is HttpException -> {
                        showErrorDialog(
                            R.string.title_api_error,
                            R.string.message_api_error)
                    }
                    else -> Log.e("QiitaAPI", "UnExpected Error")
                }
                binding.swipeRefreshLayout.isRefreshing = false
            })
        }
    }</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="202" data-enlighter-title="" data-enlighter-group="">    private fun initData() {
        // QiitaAPI実行
        viewModel.initSearch(searchType, searchQuery)
    }</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="228" data-enlighter-title="" data-enlighter-group="">    companion object { // comapnion object はstaticです
        val SEARCH_BODY = 0
        val SEARCH_TAG = 1

        private const val KEY_SEARCH_WORD = "key_search_word"
        private const val KEY_IS_SEARCH_BY_TAG = "key_is_search_by_tag"

        fun start(activity: Activity, searchWord: String, isSearchByTag: Boolean) =
            activity.startActivity(
                Intent(activity, SearchActivity::class.java)
                    .putExtra(KEY_SEARCH_WORD, searchWord)
                    .putExtra(KEY_IS_SEARCH_BY_TAG, isSearchByTag)
            )
    }</pre>


<div class="mb60"></div>


<p class="filename">ArticleViewModel.kt</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="27" data-enlighter-title="" data-enlighter-group="">fun initSearch(type: Int, query: String) {
    search(type, 1, query)
}</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="88" data-enlighter-title="" data-enlighter-group="">    /**
     * search
     *
     * @param type 0:検索 1:タグ
     * @param page 検索するページ番号
     * @param query 検索クエリ
     * @param isAdd true:追加 false:クリア
     *
     */
    fun search(type: Int, page: Int, query: String, isAdd: Boolean = false) {
        // searchQueryのエンコード
        val encodeQuery = URLEncoder.encode(query, "UTF-8");
        val client = OkHttpClient()
        val observable =
            when(type) {
                // 検索バー
                SearchActivity.SEARCH_BODY -> {
                    QiitaApi.itemsIF.searchBody(page, encodeQuery)
                }
                // タグ
                SearchActivity.SEARCH_TAG -> {
                    QiitaApi.tagsIF.searchTag(encodeQuery, page)
                }
                else -> {
                    return
                }
            }

        observable.observeOn(AndroidSchedulers.mainThread())
            .subscribeOn(Schedulers.io())
            .subscribe({
                // RecyclerViewのAdapter用のMutableList&lt;ArticleRow>に変換
                var articleRowList: MutableList&lt;ArticleRow> = mutableListOf()
                it.forEach({ resp ->
                    val row =
                        ArticleRow()
                    row.convertFromQiitaResponse(resp)
                    articleRowList.add(row)
                })
                // 取得データ反映
                setItems(articleRowList, false, isAdd)
            }, {
                currentPage = page
                isAddPrev = isAdd

                //items.postValue(listOf())
                isException.postValue(it)
            })
    }</pre>
</div></div></div></div></div></div><script>window.__NUXT__={staticAssetsBase:"/_nuxt/static/1598415284",layout:"default",error:null,serverRendered:!0,routePath:"/qiitaapplication/287/",config:{}}</script><script src="/_nuxt/runtime.8b17cd4.js" defer></script><script src="/_nuxt/pages/_slug/_id.b892f06.js" defer></script><script src="/_nuxt/vendors/commons.ca01d4b.js" defer></script><script src="/_nuxt/app.1984cc1.js" defer></script>
  </body>
</html>
